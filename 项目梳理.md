# 项目整理

## 中后台分离

### 背景
股票交易系统分为实时交易系统和清算系统。
交易系统负责生成订单、风控、向上手发送下单请求、订单成交、记录交易流水、维护用户资产的交易过程，与用户交互较多；
清算系统负责日末收集成交报告、对账、生成报表等账本业务。用户的资产以账本为准。
最开始我们拥有新西兰的清算牌照，因此交易系统和清算系统都是自研的。
清算系统直接使用交易系统的流水与上手的成交报告进行对账，并修改交易系统的资产值。
两套系统共用数据库和代码，通过本地事务的方式一致性的修改用户的资产与持仓。

现在我们要在美国展业，只能通过收购一家叫Broadrige的公司拿到美国的清算牌照。
Broadridge是一套完整的清算系统，我们需要用我们自研的交易系统对接Brodrige的清算系统。

为了对接新的清算系统，复用自研的交易系统，并为以后对接更多的清算系统，我们要把现有的交易系统和清算系统进行拆分。
交易系统即划分为中台，清算系统即划分为后台。

### 实现方案
关键词：分库分表，分布式事务，本地消息表，kafka，可靠性、顺序性、幂等性、实时性，thrift，finagle。

中后台共用的数据库，改为各自独立的数据库。中台维护订单、资产、持仓、流水等表，后台维护账本相关数据表。

中后台各自完成业务流程，并通过消息交互，中台把实时交易消息同步给后台，后台日末对账结束后再把消息同步给中台。

中后台交互使用kafka作为消息中间件，主要考虑到kafka的可靠性和高吞吐的特性。

实时性。由于结算任务是T+1进行，是在日末收盘后进行，因此对实时性要求不高，只要在结算前把消息同步即可。
因此，中台使用定时任务批量同步交易信息。避开交易时段的数据同步，可以减少对实时交易的性能影响，减少死锁发生的可能。

可靠性。kafka本身的可靠性保证了消息不会丢失，我们只需要保证消息一定可以发送。
通过本地消息表的方式，在本地事务里写下交易数据和同步消息。同步定时任务会扫描未发送的消息并发送。
发送任务通过ack确认、重试、报警的方式，保证消息一定发送成功。运维工具也可以指定消息重发。

顺序性。对账需要交易的流水，资产的变动，而不是资产的余额。通过流水可以汇总出余额。
流水对顺序性没有要求，只要求可靠性，因此乱序是可以接收的。
如果同步余额，则要考虑顺序性，此时使用时间戳即可，旧的消息直接丢弃。

幂等性。为了保证可靠性，发送端会进行重试，因此接收端必须保证幂等。
每条消息都带有全局唯一ID，并会存储这条消息。对于重复消息直接过滤即可。

最终一致性。通过日末对账进行最终一致性的保证。此时就需要考虑消息的顺序了。覆盖之前先需要对账，有问题需要告警人工处理。

### 问题及解决方案
1. 如何保证数据的一致性？为什么不用分布式事务框架？
通过本地消息表、重试、幂等、对账，保证数据的一致性。

分布式事务框架seata，经过性能测试，导致性能下降30%。

2. 如何避免超买？
以出金为例，如果以消息的方式异步锁定中台资产，在后台已经出金完成，中台还没有消费消息的时候，中后台资产出现短时间的不一致。
此时用户如果交易买入，则会出现超买现象。

出金锁定资产，使用rpc同步调用的方式，锁定成功以后才真正出金。
出金和rpc锁定资金放在一个事务里执行，先操作数据库，再调用rpc。避免先调用rpc，后写入数据库导致的rpc无法回滚问题。